name: Run ORB Analyzer Scheduled

on:
  workflow_dispatch:
  repository_dispatch:
    types: [workflow_trigger]
    
jobs:
  run_orb_analyzer:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 1. CHECKOUT CODE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 2. SETUP PYTHON
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 3. INSTALL DEPENDENCIES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements_gdrive.txt

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 4. CREATE DIRECTORIES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Create required directories
        run: |
          mkdir -p trading_logs
          echo "âœ… Created trading_logs directory"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 5. SETUP GOOGLE DRIVE CREDENTIALS (SERVICE ACCOUNT)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Setup Google Drive Service Account Credentials
        run: |
          if [ -z "${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}" ]; then
            echo "âš ï¸  GOOGLE_DRIVE_CREDENTIALS not set. Google Drive upload will be disabled."
            echo "USE_GOOGLE_DRIVE=false" >> $GITHUB_ENV
          else
            echo "${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}" | base64 --decode > service_account.json
            if [ -f "service_account.json" ]; then
              echo "âœ… Service account credentials loaded successfully"
              echo "USE_GOOGLE_DRIVE=true" >> $GITHUB_ENV
            else
              echo "âŒ Failed to create service_account.json"
              echo "USE_GOOGLE_DRIVE=false" >> $GITHUB_ENV
            fi
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 6. RUN ORB ANALYZER
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Run ORB Analyzer
        run: |
          echo "ğŸš€ Starting ORB Analyzer..."
          python orb_analyzer_UPDATED_v2.py
        env:
          TWELVEDATA_API_KEY: ${{ secrets.TWELVEDATA_API_KEY }}
          USE_GOOGLE_SHEETS: 'true'
          GDRIVE_SHEET_NAME: 'ORB Trading Log'
          GDRIVE_SHEET_ID: ${{ secrets.GDRIVE_SHEET_ID }}
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
        continue-on-error: true

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 7. UPLOAD LOGS AS ARTIFACT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Upload trading logs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: trading_logs_${{ github.run_number }}
          path: trading_logs/
          retention-days: 30
        if: always()
        continue-on-error: true

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 8. COMMIT LOGS TO REPOSITORY (BACKUP)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Commit and push trading logs to repository
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub ORB Analyzer Bot"
          
          # Check if there are changes
          if git status trading_logs/ | grep -q "modified\|new file"; then
            git add trading_logs/
            git commit -m "ğŸ¤– Auto: Update trading logs - $(date '+%Y-%m-%d %H:%M:%S UTC')"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            echo "âœ… Logs committed and pushed to repository"
          else
            echo "â„¹ï¸  No changes in trading logs"
          fi
        continue-on-error: true

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 9. SEND NOTIFICATION (Optional - requires Discord webhook)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Send Discord notification (optional)
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="âœ… SUCCESS"
            COLOR="65280"
          else
            STATUS="âš ï¸ COMPLETED WITH ERRORS"
            COLOR="16776960"
          fi
          
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"embeds\": [{
                  \"title\": \"$STATUS - ORB Analyzer Run\",
                  \"color\": $COLOR,
                  \"fields\": [
                    {\"name\": \"Repository\", \"value\": \"${{ github.repository }}\", \"inline\": true},
                    {\"name\": \"Run Number\", \"value\": \"${{ github.run_number }}\", \"inline\": true},
                    {\"name\": \"Branch\", \"value\": \"${{ github.ref }}\", \"inline\": true},
                    {\"name\": \"Time\", \"value\": \"$(date -u '+%Y-%m-%d %H:%M:%S UTC')\", \"inline\": true}
                  ],
                  \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                }]
              }"
          fi
        continue-on-error: true

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 10. CLEANUP
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f service_account.json
          rm -f credentials.json
          echo "âœ… Cleanup complete"
